{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Claims IQ Core - Document Correction Payload",
  "description": "Canonical correction schema for AI-driven PDF document processing in insurance claims. This schema defines the structure that Claims IQ Core outputs after analyzing claim documents, which is then consumed by a PDF processing engine (e.g., Nutrient) to apply corrections. v2 extends the schema with estimate validation, policy context, and additional document/correction types while maintaining full backward compatibility with v1 payloads.",
  "version": "2.0.0",
  "type": "object",
  "required": ["correction_job_id", "claim_context", "documents", "generated_at"],
  "properties": {
    "correction_job_id": {
      "type": "string",
      "description": "Unique identifier for this correction job (UUID v4)",
      "pattern": "^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$"
    },
    "schema_version": {
      "type": "string",
      "description": "Schema version used to generate this payload (e.g., '1.0.0' or '2.0.0'). Omission implies v1.",
      "default": "2.0.0"
    },
    "generated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when this correction payload was generated"
    },
    "claim_context": {
      "type": "object",
      "description": "Shared claim-level context extracted across all documents. Used for cross-document validation and estimate-vs-policy checks.",
      "required": ["claim_number", "policy_number", "insured_name"],
      "properties": {
        "claim_number": { "type": "string" },
        "policy_number": { "type": "string" },
        "insured_name": { "type": "string" },
        "date_of_loss": { "type": "string", "format": "date" },
        "property_address": { "type": "string" },
        "policy_context": {
          "type": "object",
          "description": "v2: Policy-level context needed for estimate validation. All fields optional for backward compatibility.",
          "properties": {
            "policy_type": {
              "type": "string",
              "description": "Policy form type (e.g., 'HO-3', 'HO-5', 'HO 80 03')"
            },
            "state_code": {
              "type": "string",
              "description": "Two-letter state code where the policy is written (e.g., 'MO', 'IN', 'CO'). Determines regulatory rules.",
              "pattern": "^[A-Z]{2}$"
            },
            "loss_type": {
              "type": "string",
              "description": "Peril/cause of loss classification",
              "enum": ["wind", "hail", "wind_hail", "fire", "water", "lightning", "theft", "vandalism", "other"]
            },
            "catastrophe_code": {
              "type": ["string", "null"],
              "description": "CAT code if this is part of a catastrophe event"
            },
            "endorsements": {
              "type": "array",
              "description": "Policy endorsements that modify coverage rules",
              "items": {
                "type": "object",
                "required": ["endorsement_code"],
                "properties": {
                  "endorsement_code": {
                    "type": "string",
                    "description": "Endorsement identifier (e.g., 'HO 86 05', 'HO 88 02', '0069P', '0070P', 'END. 584G')"
                  },
                  "endorsement_name": {
                    "type": "string",
                    "description": "Human-readable name (e.g., 'Roof Surface Payment Schedule', 'Indiana Amendatory Endorsement')"
                  },
                  "effect": {
                    "type": "string",
                    "description": "What this endorsement modifies (e.g., 'roof_depreciation_method', 'cosmetic_damage_exclusion', 'coverage_type_override')"
                  }
                }
              }
            },
            "coverage": {
              "type": "object",
              "description": "Coverage limits and deductibles from the policy",
              "properties": {
                "coverage_a_dwelling": { "type": "number", "description": "Dwelling coverage limit" },
                "coverage_b_other_structures": { "type": "number" },
                "coverage_c_personal_property": { "type": "number" },
                "coverage_d_loss_of_use": { "type": "number" },
                "deductible_amount": { "type": "number", "description": "Standard deductible amount" },
                "deductible_type": {
                  "type": "string",
                  "enum": ["flat", "percentage", "wind_hail_separate"],
                  "description": "How the deductible is applied"
                },
                "wind_hail_deductible": {
                  "type": ["number", "null"],
                  "description": "Separate wind/hail deductible if applicable"
                },
                "cost_valuation_type": {
                  "type": "string",
                  "enum": ["RCV", "ACV"],
                  "description": "Policy-level cost valuation: Replacement Cost Value or Actual Cash Value"
                }
              }
            },
            "roof_context": {
              "type": "object",
              "description": "Roof-specific policy and property context for depreciation validation",
              "properties": {
                "roof_installation_year": {
                  "type": "integer",
                  "description": "Year the roof was installed (from FNOL or inspection)"
                },
                "roof_age_at_loss": {
                  "type": "integer",
                  "description": "Calculated age of roof in years at date of loss"
                },
                "roof_material_type": {
                  "type": "string",
                  "description": "Primary roof material (e.g., '3-Tab Shingle', 'Architectural Shingle', 'Metal', 'Tile')"
                },
                "depreciation_method": {
                  "type": "string",
                  "enum": ["none", "age_based", "condition_based", "age_and_condition", "schedule", "roof_payment_schedule"],
                  "description": "Depreciation method dictated by policy endorsements"
                },
                "roof_coverage_type": {
                  "type": "string",
                  "enum": ["RCV", "ACV"],
                  "description": "Roof-specific coverage type (may differ from policy-level if endorsement overrides)"
                },
                "cosmetic_damage_excluded": {
                  "type": "boolean",
                  "default": false,
                  "description": "Whether the policy excludes cosmetic damage to the roof"
                }
              }
            }
          }
        }
      }
    },
    "documents": {
      "type": "array",
      "description": "Array of documents analyzed in this correction batch",
      "items": { "$ref": "#/definitions/document" }
    },
    "cross_document_validations": {
      "type": "array",
      "description": "Issues found by comparing data across multiple documents in the claim file",
      "items": { "$ref": "#/definitions/cross_document_validation" }
    },
    "estimate_validations": {
      "type": "array",
      "description": "v2: Issues found by comparing estimate line items against policy terms, endorsements, and coverage rules. This is the policy-vs-estimate validation layer.",
      "items": { "$ref": "#/definitions/estimate_validation" }
    },
    "summary": {
      "type": "object",
      "description": "Rollup statistics for the correction job",
      "properties": {
        "total_corrections": { "type": "integer" },
        "total_annotations": { "type": "integer" },
        "total_cross_doc_flags": { "type": "integer" },
        "total_estimate_validations": {
          "type": "integer",
          "description": "v2: Count of estimate-vs-policy validation findings"
        },
        "severity_counts": {
          "type": "object",
          "properties": {
            "critical": { "type": "integer" },
            "warning": { "type": "integer" },
            "info": { "type": "integer" }
          }
        },
        "confidence_average": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Average AI confidence across all corrections"
        }
      }
    }
  },
  "definitions": {
    "document": {
      "type": "object",
      "required": ["document_id", "document_type", "source_filename", "corrections"],
      "properties": {
        "document_id": {
          "type": "string",
          "description": "Unique ID for this document within the claim file"
        },
        "document_type": {
          "type": "string",
          "enum": [
            "fnol",
            "activity_report",
            "invoice",
            "estimate",
            "photos",
            "correspondence",
            "policy_dec",
            "supplement",
            "narrative",
            "billing_sheet",
            "policy_endorsement",
            "estimate_audit_report",
            "assignment_notes",
            "client_policy_summary",
            "roof_payment_schedule",
            "other"
          ],
          "description": "Claims IQ document classification. v2 adds: narrative, billing_sheet, policy_endorsement, estimate_audit_report, assignment_notes, client_policy_summary, roof_payment_schedule"
        },
        "source_filename": {
          "type": "string",
          "description": "Original filename of the PDF (or HTML for assignment_notes/client_policy_summary)"
        },
        "source_format": {
          "type": "string",
          "enum": ["pdf", "html", "xml", "image"],
          "default": "pdf",
          "description": "v2: File format of the source document"
        },
        "page_count": {
          "type": "integer"
        },
        "corrections": {
          "type": "array",
          "description": "Text replacement corrections to apply to this document",
          "items": { "$ref": "#/definitions/correction" }
        },
        "annotations": {
          "type": "array",
          "description": "Non-destructive annotations (highlights, comments, flags) to add",
          "items": { "$ref": "#/definitions/annotation" }
        }
      }
    },
    "correction": {
      "type": "object",
      "description": "A single text correction to apply to the PDF",
      "required": ["correction_id", "type", "severity", "location", "original_value", "corrected_value", "reason"],
      "properties": {
        "correction_id": {
          "type": "string",
          "description": "Unique ID for tracking this specific correction"
        },
        "type": {
          "type": "string",
          "enum": [
            "typo",
            "date_error",
            "phone_format",
            "name_mismatch",
            "address_error",
            "numeric_error",
            "missing_value",
            "format_standardization",
            "data_inconsistency",
            "depreciation_method_error",
            "depreciation_calculation_error",
            "cost_valuation_type_error",
            "deductible_error",
            "coverage_applicability_error",
            "line_item_error",
            "policy_endorsement_conflict",
            "roof_age_error"
          ],
          "description": "Classification of the error type. v2 adds estimate validation types: depreciation_method_error, depreciation_calculation_error, cost_valuation_type_error, deductible_error, coverage_applicability_error, line_item_error, policy_endorsement_conflict, roof_age_error"
        },
        "severity": {
          "type": "string",
          "enum": ["critical", "warning", "info"],
          "description": "critical = must fix (affects claim validity or payment), warning = should fix (data quality or compliance risk), info = cosmetic/optional"
        },
        "location": {
          "$ref": "#/definitions/location",
          "description": "Where in the PDF the error occurs"
        },
        "original_value": {
          "type": "string",
          "description": "The current (incorrect) text in the document"
        },
        "corrected_value": {
          "type": "string",
          "description": "The replacement text to apply"
        },
        "reason": {
          "type": "string",
          "description": "Human-readable explanation of why this correction is needed"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "AI confidence score for this correction (0.0 to 1.0)"
        },
        "requires_human_review": {
          "type": "boolean",
          "default": false,
          "description": "If true, flag for adjuster review before applying"
        },
        "evidence": {
          "type": "object",
          "description": "Supporting evidence from other documents or external sources",
          "properties": {
            "source_document_id": {
              "type": "string",
              "description": "Document ID where the correct value was found"
            },
            "source_field": {
              "type": "string",
              "description": "Field name in the source document"
            },
            "validation_method": {
              "type": "string",
              "enum": ["cross_document", "pattern_match", "external_lookup", "contextual_inference", "policy_rule", "endorsement_rule", "depreciation_schedule"],
              "description": "How the correct value was determined. v2 adds: policy_rule, endorsement_rule, depreciation_schedule"
            },
            "policy_reference": {
              "type": "string",
              "description": "v2: Specific policy clause, endorsement code, or rule that governs this correction (e.g., 'HO 88 02 — Roof Surface Payment Schedule')"
            }
          }
        }
      }
    },
    "annotation": {
      "type": "object",
      "description": "A non-destructive annotation to add to the PDF (highlight, comment, flag)",
      "required": ["annotation_id", "type", "location", "message"],
      "properties": {
        "annotation_id": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "enum": ["highlight", "comment", "flag", "strikethrough", "underline"],
          "description": "Visual annotation type"
        },
        "severity": {
          "type": "string",
          "enum": ["critical", "warning", "info"]
        },
        "location": {
          "$ref": "#/definitions/location"
        },
        "message": {
          "type": "string",
          "description": "Annotation text / comment content"
        },
        "color": {
          "type": "string",
          "description": "Hex color code for the annotation",
          "pattern": "^#[0-9a-fA-F]{6}$",
          "default": "#FFFF00"
        },
        "category": {
          "type": "string",
          "enum": [
            "data_quality",
            "compliance",
            "review_needed",
            "cross_doc_mismatch",
            "suspicious",
            "estimate_policy_conflict",
            "depreciation_issue",
            "coverage_question"
          ],
          "description": "Categorization for filtering and reporting. v2 adds: estimate_policy_conflict, depreciation_issue, coverage_question"
        }
      }
    },
    "cross_document_validation": {
      "type": "object",
      "description": "A discrepancy found between two or more documents in the claim file",
      "required": ["validation_id", "field_name", "severity", "occurrences", "message"],
      "properties": {
        "validation_id": {
          "type": "string"
        },
        "field_name": {
          "type": "string",
          "description": "The logical field being compared (e.g., 'insured_phone', 'loss_amount', 'date_of_loss', 'deductible_amount', 'coverage_type')"
        },
        "severity": {
          "type": "string",
          "enum": ["critical", "warning", "info"]
        },
        "occurrences": {
          "type": "array",
          "description": "Each occurrence of this field across documents",
          "items": {
            "type": "object",
            "required": ["document_id", "value", "location"],
            "properties": {
              "document_id": { "type": "string" },
              "document_type": { "type": "string" },
              "value": { "type": "string" },
              "location": { "$ref": "#/definitions/location" }
            }
          }
        },
        "expected_value": {
          "type": ["string", "null"],
          "description": "The value Claims IQ Core believes is correct (null if uncertain)"
        },
        "message": {
          "type": "string",
          "description": "Human-readable explanation of the discrepancy"
        },
        "recommended_action": {
          "type": "string",
          "enum": ["auto_correct", "flag_for_review", "escalate", "informational"],
          "description": "What Claims IQ recommends doing about this discrepancy"
        }
      }
    },
    "estimate_validation": {
      "type": "object",
      "description": "v2: A finding from comparing estimate content against policy terms. These are not simple text corrections — they represent logic errors where the estimate doesn't comply with policy rules.",
      "required": ["validation_id", "validation_type", "severity", "message", "estimate_document_id"],
      "properties": {
        "validation_id": {
          "type": "string",
          "description": "Unique ID for this validation finding"
        },
        "validation_type": {
          "type": "string",
          "enum": [
            "incorrect_deductible",
            "incorrect_depreciation_method",
            "incorrect_cost_valuation",
            "cosmetic_damage_exclusion_violation",
            "roof_age_depreciation_mismatch",
            "coverage_limit_exceeded",
            "endorsement_not_applied",
            "line_item_not_covered",
            "depreciation_percentage_error",
            "depreciation_schedule_vs_age",
            "rcv_acv_mismatch",
            "tax_calculation_error",
            "missing_required_documentation"
          ],
          "description": "Classification of the estimate validation error"
        },
        "severity": {
          "type": "string",
          "enum": ["critical", "warning", "info"]
        },
        "estimate_document_id": {
          "type": "string",
          "description": "Document ID of the estimate being validated"
        },
        "policy_document_id": {
          "type": ["string", "null"],
          "description": "Document ID of the policy/endorsement document that defines the rule (null if rule comes from claim_context)"
        },
        "location": {
          "$ref": "#/definitions/location",
          "description": "Where in the estimate the error occurs"
        },
        "line_item": {
          "type": "object",
          "description": "The specific estimate line item involved (if applicable)",
          "properties": {
            "description": {
              "type": "string",
              "description": "Line item description from the estimate"
            },
            "category": {
              "type": "string",
              "description": "Estimate category (e.g., 'Roofing', 'Siding', 'Interior')"
            },
            "quantity": { "type": "number" },
            "unit_cost": { "type": "number" },
            "rcv_amount": { "type": "number", "description": "Replacement Cost Value for this line item" },
            "depreciation_pct": { "type": "number", "description": "Depreciation percentage applied" },
            "depreciation_amount": { "type": "number" },
            "acv_amount": { "type": "number", "description": "Actual Cash Value for this line item" }
          }
        },
        "expected": {
          "type": "object",
          "description": "What the correct values should be based on policy rules",
          "properties": {
            "value": { "type": "string", "description": "The correct value or method" },
            "rule_source": {
              "type": "string",
              "description": "Which policy term, endorsement, or regulation governs this (e.g., 'HO 88 02 — Roof Surface Payment Schedule', 'Policy declarations — ACV coverage')"
            },
            "calculation": {
              "type": "string",
              "description": "How the correct value was calculated (e.g., 'Roof age 22 years ÷ 30 year life = 73.3% depreciation per RPS schedule')"
            }
          }
        },
        "found": {
          "type": "object",
          "description": "What was actually in the estimate",
          "properties": {
            "value": { "type": "string", "description": "The value or method found in the estimate" },
            "location": { "$ref": "#/definitions/location" }
          }
        },
        "financial_impact": {
          "type": "object",
          "description": "The dollar impact of this error on the claim settlement",
          "properties": {
            "overpayment": {
              "type": ["number", "null"],
              "description": "Positive = carrier is overpaying by this amount"
            },
            "underpayment": {
              "type": ["number", "null"],
              "description": "Positive = insured is being underpaid by this amount"
            },
            "net_impact": {
              "type": "number",
              "description": "Positive = overpayment, negative = underpayment"
            }
          }
        },
        "message": {
          "type": "string",
          "description": "Human-readable explanation of the policy-vs-estimate discrepancy"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "recommended_action": {
          "type": "string",
          "enum": ["auto_correct", "flag_for_review", "escalate", "informational"],
          "description": "What Claims IQ recommends"
        }
      }
    },
    "location": {
      "type": "object",
      "description": "Precise location of text within a PDF page",
      "required": ["page"],
      "properties": {
        "page": {
          "type": "integer",
          "minimum": 1,
          "description": "1-indexed page number"
        },
        "bbox": {
          "type": "object",
          "description": "Bounding box coordinates (PDF coordinate system: origin at bottom-left)",
          "properties": {
            "x": { "type": "number", "description": "Left edge (points from left)" },
            "y": { "type": "number", "description": "Bottom edge (points from bottom)" },
            "width": { "type": "number" },
            "height": { "type": "number" }
          }
        },
        "text_context": {
          "type": "string",
          "description": "Surrounding text to help locate the target (for fuzzy matching when exact coordinates aren't available)"
        },
        "search_text": {
          "type": "string",
          "description": "The exact text string to search for in the PDF (fallback when bbox isn't precise)"
        }
      }
    }
  }
}
